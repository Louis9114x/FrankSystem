<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Frank Finder – Subway Style</title>
<style>
  :root {
    --bg:#0b1520; --panel:#0f2233; --text:#e8f0f7; --muted:#9eb6cb;
    --accent:#4aa3ff; --accent2:#8fd3ff; --good:#27d980; --warn:#ffb84a;
    --radius:16px;
  }
  html,body{height:100%;margin:0;background:radial-gradient(1200px 800px at 30% 20%,#11283b 0%,var(--bg) 60%);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:860px;margin:0 auto;padding:28px 18px 44px;min-height:100%;display:grid;align-content:center;gap:22px}
  h1{margin:0;font-size:clamp(22px,4vw,34px);font-weight:800;letter-spacing:.2px}
  .panel{background:linear-gradient(180deg,#0f1f2d,var(--panel));border:1px solid #1f3a54;border-radius:var(--radius);padding:18px;box-shadow:0 12px 28px rgba(0,0,0,.35),inset 0 1px 0 rgba(255,255,255,.03)}
  .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .hint{color:var(--muted);font-size:14px}
  button{appearance:none;border:0;border-radius:12px;padding:12px 18px;background:linear-gradient(180deg,#5cb2ff,#2c86e6);color:#fff;font-weight:800;letter-spacing:.2px;cursor:pointer;box-shadow:0 8px 18px rgba(76,160,255,.35);transition:transform .12s,filter .12s,opacity .2s}
  button:hover{transform:translateY(-1px);filter:brightness(1.05)}
  button:active{transform:translateY(0);filter:brightness(.95)}
  button:disabled{opacity:.55;cursor:not-allowed;box-shadow:none}
  .stage{display:grid;justify-items:center;gap:16px;padding:10px}
  .logo-wrap{width:min(360px,60vw);aspect-ratio:1/1;display:grid;place-items:center;border-radius:20px;background:radial-gradient(60% 60% at 50% 40%,rgba(90,170,255,.08),transparent)}
  .logo{width:86%;height:86%;object-fit:contain;filter:drop-shadow(0 12px 24px rgba(0,0,0,.35))}
  .spinning{animation:spin 2.5s linear infinite;will-change:transform}
  @keyframes spin{to{transform:rotate(360deg)}}
  .progress{width:100%;height:16px;background:#0a1824;border-radius:999px;border:1px solid #16344f;overflow:hidden;position:relative}
  .progress>.bar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent),var(--accent2));box-shadow:0 0 24px rgba(90,170,255,.35) inset;transition:width .12s linear}
  .percent{font-variant-numeric:tabular-nums;font-weight:700;color:var(--accent2)}
  .time{color:var(--muted);font-variant-numeric:tabular-nums}
  .compass-card{display:none;grid-template-rows:auto auto 1fr;gap:14px;align-items:center;justify-items:center;margin-top:6px}
  .compass-face{width:min(320px,70vw);aspect-ratio:1/1;border-radius:50%;border:2px solid #224a6d;display:grid;place-items:center;position:relative;background:radial-gradient(60% 60% at 50% 40%,rgba(90,170,255,.06),transparent)}
  .needle{width:6px;height:36%;background:linear-gradient(180deg,#ff6b6b,#ff3131);position:absolute;top:14%;border-radius:4px;transform-origin:50% 86%;box-shadow:0 0 10px rgba(255,80,80,.5)}
  .north-dot{position:absolute;top:6px;left:50%;transform:translateX(-50%);width:8px;height:8px;background:#ff6666;border-radius:50%}
  .arrow-target{position:absolute;width:0;height:0;border-left:12px solid transparent;border-right:12px solid transparent;border-bottom:22px solid #27d980;bottom:10%;filter:drop-shadow(0 4px 10px rgba(39,217,128,.5))}
  .stats{display:flex;gap:12px;flex-wrap:wrap;justify-content:center}
  .pill{border:1px solid #294a69;background:#0d2032;border-radius:999px;padding:8px 12px;font-variant-numeric:tabular-nums}
  .center{text-align:center}
  .hidden{display:none !important}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Frank Finder</h1>
      <p class="hint">Subway-style mini game • Load the program, then “Start Searching” → follow the compass • 100 steps.</p>
    </header>

    <section class="panel">
      <div class="row">
        <button id="startBtn">Start Program</button>
        <button id="searchBtn" class="hidden">Start Searching</button>
        <button id="againBtn" class="hidden">Play again</button>
        <span class="hint">Status: <span id="statusText">Ready</span></span>
      </div>

      <div class="stage" id="stageLoading">
        <div class="logo-wrap">
          <img id="logo" class="logo" src="data:image/png;base64," alt="Logo" />
        </div>
        <div class="progress"><div id="bar" class="bar"></div></div>
        <div><span class="percent" id="pct">0%</span><span class="time" id="eta"></span></div>
      </div>

      <div id="stageCompass" class="compass-card">
        <div class="stats">
          <div class="pill">Target: <span id="targetDeg">---</span>°</div>
          <div class="pill">Heading: <span id="headingDeg">---</span>°</div>
          <div class="pill">Diff: <span id="diffDeg">---</span>°</div>
          <div class="pill">Steps: <span id="stepsLeft">100</span>/100</div>
        </div>
        <div class="compass-face">
          <div class="north-dot"></div>
          <div class="needle" id="needle"></div>
          <div class="arrow-target" id="arrowTarget"></div>
        </div>
        <div class="row center">
          <button id="permBtn" class="hidden">Allow sensor access</button>
          <button id="stepBtn" class="hidden">+1 Step (Fallback)</button>
        </div>
        <p class="hint center" id="sensorHint">If the compass does not react: tap for permission or use fallback.</p>
      </div>

      <div id="stageDone" class="hidden center">
        <h2>You found the Frank checkpoint</h2>
      </div>
    </section>
  </div>

<script>
(function () {
  const startBtn = document.getElementById('startBtn');
  const searchBtn = document.getElementById('searchBtn');
  const againBtn = document.getElementById('againBtn');
  const statusText = document.getElementById('statusText');
  const logo = document.getElementById('logo');
  const bar = document.getElementById('bar');
  const pct = document.getElementById('pct');
  const eta = document.getElementById('eta');
  const stageLoading = document.getElementById('stageLoading');
  const stageCompass = document.getElementById('stageCompass');
  const stageDone = document.getElementById('stageDone');
  const targetDegEl = document.getElementById('targetDeg');
  const headingDegEl = document.getElementById('headingDeg');
  const diffDegEl = document.getElementById('diffDeg');
  const stepsLeftEl = document.getElementById('stepsLeft');
  const permBtn = document.getElementById('permBtn');
  const stepBtn = document.getElementById('stepBtn');
  const needle = document.getElementById('needle');
  const arrowTarget = document.getElementById('arrowTarget');

  let rafId = null;
  let running = false;
  let targetDeg = 0;
  let heading = 0;
  let stepsLeft = 100;
  let lastStepTime = 0;

  function formatTime(ms) {
    const totalSec = Math.max(0, Math.ceil(ms/1000));
    const m = Math.floor(totalSec/60);
    const s = totalSec%60;
    return String(m).padStart(2,'0')+':'+String(s).padStart(2,'0');
  }

  function startLoading() {
    if(running) return;
    const duration = (60_000+Math.random()*240_000)|0;
    running = true;
    startBtn.disabled = true;
    statusText.textContent='Loading…';
    logo.classList.add('spinning');
    const startTime=performance.now();
    function tick(now){
      const elapsed=now-startTime;
      const progress=Math.min(elapsed/duration,1);
      const percent=Math.floor(progress*100);
      bar.style.width=percent+'%';
      pct.textContent=percent+'%';
      const remaining=duration-elapsed;
      eta.textContent=' • Time left: '+formatTime(remaining);
      if(progress<1) rafId=requestAnimationFrame(tick);
      else finishLoading();
    }
    rafId=requestAnimationFrame(tick);
  }

  function finishLoading(){
    if(rafId) cancelAnimationFrame(rafId);
    running=false;
    startBtn.classList.add('hidden');
    searchBtn.classList.remove('hidden');
    logo.classList.remove('spinning');
    bar.style.width='100%';
    pct.textContent='100%';
    eta.textContent=' • Done';
    statusText.textContent='Done';
  }

  function pickTarget(){
    targetDeg=Math.floor(Math.random()*360);
    targetDegEl.textContent=targetDeg;
    arrowTarget.style.transform='rotate('+targetDeg+'deg)';
  }
  function normAngle(a){a=a%360;if(a<0)a+=360;return a;}
  function angleDiff(a,b){let d=normAngle(a)-normAngle(b);if(d>180)d-=360;if(d<-180)d+=360;return d;}
  function updateHeadingDisplay(){
    headingDegEl.textContent=Math.round(normAngle(heading));
    const diff=Math.round(Math.abs(angleDiff(targetDeg,heading)));
    diffDegEl.textContent=diff;
    needle.style.transform='rotate('+normAngle(heading)+'deg)';
  }
  function setStepsLeft(n){stepsLeft=Math.max(0,n);stepsLeftEl.textContent=stepsLeft;if(stepsLeft===0)foundFrank();}
  function foundFrank(){
    stageCompass.style.display='none';
    stageDone.classList.remove('hidden');
    againBtn.classList.remove('hidden');
    searchBtn.classList.add('hidden');
    statusText.textContent='Checkpoint reached!';
  }
  function resetGame(){
    stageDone.classList.add('hidden');
    stageCompass.style.display='none';
    stageLoading.classList.remove('hidden');
    startBtn.classList.remove('hidden');
    searchBtn.classList.add('hidden');
    againBtn.classList.add('hidden');
    statusText.textContent='Ready';
    bar.style.width='0%';pct.textContent='0%';eta.textContent='';
    stepsLeft=100;stepsLeftEl.textContent=stepsLeft;
  }

  function handleMotion(e){
    const a=e.accelerationIncludingGravity;if(!a) return;
    const mag=Math.sqrt((a.x||0)**2+(a.y||0)**2+(a.z||0)**2);
    const now=performance.now();
    if(mag>12&&now-lastStepTime>350){lastStepTime=now;setStepsLeft(stepsLeft-1);}
  }
  function handleOrientation(e){
    let hdg=0;
    if(typeof e.webkitCompassHeading==='number') hdg=e.webkitCompassHeading;
    else if(e.absolute&&typeof e.alpha==='number') hdg=360-e.alpha;
    else if(typeof e.alpha==='number') hdg=360-e.alpha;
    heading=normAngle(hdg);
    updateHeadingDisplay();
  }
  async function requestPermissionsIfNeeded(){
    const anyIOS=typeof DeviceMotionEvent!=='undefined'&&typeof DeviceMotionEvent.requestPermission==='function';
    try{
      if(anyIOS){
        const p1=await DeviceMotionEvent.requestPermission();
        const p2=(typeof DeviceOrientationEvent!=='undefined'&&typeof DeviceOrientationEvent.requestPermission==='function')
          ? await DeviceOrientationEvent.requestPermission():'granted';
        return(p1==='granted'&&p2==='granted');
      }
      return true;
    }catch(e){return false;}
  }
  function startCompass(){
    stageLoading.classList.add('hidden');
    stageCompass.style.display='grid';
    pickTarget();
    updateHeadingDisplay();
    const started=startSensors();
    if(!started){permBtn.classList.remove('hidden');stepBtn.classList.remove('hidden');}
  }
  function startSensors(){
    let ok=false;
    if(typeof window.DeviceOrientationEvent!=='undefined'){window.addEventListener('deviceorientation',handleOrientation,true);ok=true;}
    if(typeof window.DeviceMotionEvent!=='undefined'){window.addEventListener('devicemotion',handleMotion,true);ok=true;}
    return ok;
  }
  permBtn.addEventListener('click',async()=>{const granted=await requestPermissionsIfNeeded();if(granted){permBtn.classList.add('hidden');startSensors();}});
  stepBtn.addEventListener('click',()=>setStepsLeft(stepsLeft-1));
  startBtn.addEventListener('click',()=>startLoading());
  searchBtn.addEventListener('click',async()=>{await requestPermissionsIfNeeded();startCompass();});
  againBtn.addEventListener('click',()=>resetGame());
})();
</script>
</body>
</html>
